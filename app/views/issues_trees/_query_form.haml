= hidden_field_tag("set_filter", "1")
= hidden_field_tag("type", @query.type, disabled: true, id: "query_type")
= query_hidden_sort_tag(@query)

%div#query_form_with_buttons.hide-when-print
  %div#query_form_content
    %fieldset#filters{ class: "collapsible #{ @query.new_record? ? "" : "collapsed" }" }
      %legend.icon.icon-expended{ onclick: "toggleFieldset(this);" }
        = l(:label_filter_plural)
      %div{ style: "#{ @query.new_record? ? "" : "display: none;"}" }
        = render(partial: "queries/filters", locals: { query: @query })

    %fieldset#options.collapsible.collapsed
      %legend.icon.icon-collapsed{ onclick: "toggleFieldset(this);" }
        = l(:label_options)
      %div{ style: "display: none;" }
        %table
          %tr
            %td.field= l(:field_column_names)
            %td= render_query_columns_selection(@query)
          - if @query.available_block_columns.any?
            %tr
              %td.field= l(:button_show)
              %td= available_block_columns_tags(@query)
          - if @query.available_totalable_columns.any?
            %tr
              %td= l(:label_total_plural)
              %td= available_totalable_columns_tags(@query)

  %p.buttons
    = link_to_function(l(:button_apply), "$('#query_form').submit();", class: "icon icon-checked")
    = link_to(l(:button_clear), { set_filter: 1, sort: "", project_id: @project }, class: "icon icon-reload")
    - if @query.new_record?
      - if User.current.allowed_to?(:save_queries, @project, global: true)
        = link_to_function(l(:button_save),
                           "$('#query_type').prop('disabled', false); $('#query_form').attr('action', '#{ @project ? new_project_query_path(@project) : new_query_path }').submit();",
                           class: "icon icon-save")
    - else
      - if @query.editable_by?(User.current)
        = link_to(l(:button_edit), edit_query_path(@query), class: "icon icon-edit")
        = delete_link(query_path(@query))

= error_messages_for @query
